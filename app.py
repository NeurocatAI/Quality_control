# app.py 
import streamlit as st
import openai
import os
from utils.transcription import transcribe_audio
from utils.dialogue_formatting import format_dialogue
from utils.quality_control import quality_control
from utils.error_detection import detect_errors
from utils.recommendations import generate_recommendations
from utils.client_questions import extract_client_questions
from utils.save_to_google_sheets import save_to_google_sheets
import tempfile

# –ü–æ–ª—É—á–µ–Ω–∏–µ PIN-–∫–æ–¥–∞ –∏ –∫–ª—é—á–∞ API –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
USER_PIN = st.secrets["USER_PIN"]

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —Ñ–ª–∞–≥ –¥–æ—Å—Ç—É–ø–∞ –≤ —Å–µ—Å—Å–∏–∏
if 'access_granted' not in st.session_state:
    st.session_state['access_granted'] = False

# –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ PIN-–∫–æ–¥–∞
if not st.session_state['access_granted']:
    with st.form(key='pin_form'):
        pin = st.text_input("–í–≤–µ–¥–∏—Ç–µ PIN –¥–ª—è –¥–æ—Å—Ç—É–ø–∞", type="password")
        submit_button = st.form_submit_button("–í–æ–π—Ç–∏")
    if submit_button:
        if pin == USER_PIN:
            st.session_state['access_granted'] = True
            st.success("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω")
        else:
            st.warning("–ù–µ–≤–µ—Ä–Ω—ã–π PIN. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            st.stop()
    else:
        st.stop()

# –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if st.session_state['access_granted']:
    # –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API-–∫–ª—é—á–∞
    openai.api_key = OPENAI_API_KEY

    st.title("–ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")

    # –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞
    audio_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª", type=["mp3", "wav", "m4a"])

    if audio_file is not None:
        if st.button("–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑"):
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            with tempfile.NamedTemporaryFile(delete=False, suffix=".wav") as tmp_file:
                tmp_file.write(audio_file.read())
                tmp_file_path = tmp_file.name

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
            file_name = audio_file.name

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –≤–∫–ª–∞–¥–æ–∫
            tab_statuses = {
                "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è": "in_progress",
                "–î–∏–∞–ª–æ–≥": "not_started",
                "–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ—Ü–µ–Ω–∫–∏": "not_started",
                "–û—à–∏–±–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞": "not_started",
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": "not_started",
                "–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞": "not_started"
            }

            # –í—ã–ø–æ–ª–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
            with st.spinner("–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ..."):
                transcription = transcribe_audio(tmp_file_path)
                tab_statuses["–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è"] = "completed"
                tab_statuses["–î–∏–∞–ª–æ–≥"] = "in_progress"

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥
            with st.spinner("–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥..."):
                formatted_dialogue = format_dialogue(transcription)
                tab_statuses["–î–∏–∞–ª–æ–≥"] = "completed"
                tab_statuses["–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ—Ü–µ–Ω–∫–∏"] = "in_progress"
            
            # –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏
            criteria = """
            1. –£—Å—Ç–∞–Ω–æ–≤–∏–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–µ–±—è –∏—Å—Ö–æ–¥—è –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞, –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏). –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –∫–æ–Ω—Ç–∞–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–∏–ª, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–∏–ª, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—É–Ω–∫—Ç—ã —É–ø—É—Å—Ç–∏–ª, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
            2. –ë—ã–ª–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–∏–∞–ª–æ–≥ (–ø—Ä–æ–≥–æ–≤–æ—Ä–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏–∞–ª–æ–≥–∞, –ø–æ–ª—É—á–∏–ª —Å–æ–≥–ª–∞—Å–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –≤—ã—è—Å–Ω–∏–ª –æ—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª –æ –Ω–∞—Å –∫–ª–∏–µ–Ω—Ç, –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å). –û—Ü–µ–Ω–∫–∞ "1" –¥–∞, –≤—ã–ø–æ–ª–Ω–∏–ª –ø—Ä–æ–≥—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–∏–∞–ª–æ–≥, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª –ø—Ä–æ–≥—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–∏–∞–ª–æ–≥, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—É–Ω–∫—Ç—ã —É–ø—É—Å—Ç–∏–ª, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –ø—Ä–æ–≥—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–∏–∞–ª–æ–≥ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª.
            3. –ó–∞–¥–∞–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä 2 –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ, –∑–∞–¥–∞–Ω –≤—Å–µ–≥–æ –æ–¥–∏–Ω —Å–∏—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –∑–∞–¥–∞–Ω—ã.
            4. –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –ª–∏ —Å—É–º–º–∞ –¥–æ–ª–≥–∞ –∏—Å—Ö–æ–¥—è –∏–∑ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π, —Å—É–º–º–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É, —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –ª–∏ —Ä–∞—Å—á–µ—Ç –ø–æ —É–¥–µ—Ä–∂–∞–Ω–∏—è–º –¥–æ—Ö–æ–¥–æ–≤, –µ—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –ø—Ä–∏—Å—Ç–∞–≤—ã. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—É–Ω–∫—Ç—ã —É–ø—É—â–µ–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.
            5. –ë—ã–ª –ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∏ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω –∫–µ–π—Å ‚Ññ1 —Å –∏–º–µ–Ω–µ–º –∫–ª–∏–µ–Ω—Ç–∞, —Å—É–º–º–æ–π –¥–æ–ª–≥–∞ –∏ –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –∫–µ–π—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω, –æ—Ü–µ–Ω–∫–∞ "0.5" - –∫–µ–π—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ, —É–ø–æ–º—è–Ω—É—Ç –≤–∫—Ä–∞—Ç—Ü–µ –∏–ª–∏ –±–µ–∑ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –∫–µ–π—Å –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω.
            6. –í—ã—è–≤–∏–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –±–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –±–æ–ª—å –≤—ã—è–≤–ª–µ–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã—è–≤–ª–µ–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –±–æ–ª—å –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞.
            7. –ë—ã–ª–æ –ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —ç–º–ø–∞—Ç–∏—è, —É—Å–∏–ª–µ–Ω–∏–µ –±–æ–ª–∏ —á–µ—Ä–µ–∑ –∫–µ–π—Å ‚Ññ2. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.
            8. –ù–∞—Ä–∏—Å–æ–≤–∞–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ –±—É–¥—É—â–µ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É—è –±–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞.
            9. –ë—ã–ª–∞ –ª–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω–∞ —Å—Ö–µ–º–∞ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∫–µ–π—Å ‚Ññ3, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, —Å—Ö–µ–º–∞ –∏ –∫–µ–π—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã.
            10.  –£—Ç–æ—á–Ω–∏–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –∑–∞–¥–∞–≤ –≤–æ–ø—Ä–æ—Å "–ù—Ä–∞–≤–∏—Ç—Å—è –ª–∏ –≤–∞–º –∏–¥–µ—è —Å–ø–∏—Å–∞—Ç—å –¥–æ–ª–≥–∏?". –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –≤–æ–ø—Ä–æ—Å –∑–∞–¥–∞–Ω, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –≤–æ–ø—Ä–æ—Å –Ω–µ –∑–∞–¥–∞–Ω.
            10. –£—Ç–æ—á–Ω–∏–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –∑–∞–¥–∞–≤ –≤–æ–ø—Ä–æ—Å "–ù—Ä–∞–≤–∏—Ç—Å—è –ª–∏ –≤–∞–º –∏–¥–µ—è —Å–ø–∏—Å–∞—Ç—å –¥–æ–ª–≥–∏?". –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –≤–æ–ø—Ä–æ—Å –∑–∞–¥–∞–Ω, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –≤–æ–ø—Ä–æ—Å –Ω–µ –∑–∞–¥–∞–Ω.
            11. –ü–æ–ø—ã—Ç–∞–ª—Å—è –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø–æ–ª–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∏–ª–∏ –Ω–∞ —Ä–∞—Å—Å—Ä–æ—á–∫—É –º–µ–Ω–µ–µ 10 –º–µ—Å—è—Ü–µ–≤, –∑–∞–¥–∞–≤ –≤–æ–ø—Ä–æ—Å ‚Äú–ó–∞ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –±—ã —Å —ç—Ç–æ–π —Å—É–º–º–æ–π?‚Äù. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ —Å–¥–µ–ª–∞–Ω–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —Å–¥–µ–ª–∞–Ω–∞.
            12. –ë—ã–ª –ª–∏ —Å–¥–µ–ª–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ—Ñ—Ñ–µ—Ä–∞/–±–æ–ª–∏/–ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–∞. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –ø—Ä–∏–∑—ã–≤ —Å–¥–µ–ª–∞–Ω, –æ—Ü–µ–Ω–∫–∞ "0.5" - —á–∞—Å—Ç–∏—á–Ω–æ —Å–¥–µ–ª–∞–Ω, –∏ —á—Ç–æ-—Ç–æ —É–ø—É—â–µ–Ω–æ –∏–∑ –æ—Ñ—Ñ–µ—Ä–∞/–±–æ–ª–∏/–ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –ø—Ä–∏–∑—ã–≤ –Ω–µ —Å–¥–µ–ª–∞–Ω.
            13. –£–ø–æ–º—è–Ω—É–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É. –û—Ü–µ–Ω–∫–∞ "1" - –¥–∞, –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É–ø–æ–º—è–Ω—É—Ç–∞, –æ—Ü–µ–Ω–∫–∞ "0" - –Ω–µ—Ç, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —É–ø–æ–º—è–Ω—É—Ç–∞.
            """

           # –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞
            with st.spinner("–ü—Ä–æ–≤–æ–¥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞..."):
                qc_analysis, scores = quality_control(formatted_dialogue, criteria)
                average_score = sum(scores) / len(scores) if scores else 0
                tab_statuses["–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ—Ü–µ–Ω–∫–∏"] = "completed"
                tab_statuses["–û—à–∏–±–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"] = "in_progress"

            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
            with st.spinner("–û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—à–∏–±–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞..."):
                manager_errors = detect_errors(formatted_dialogue)
                tab_statuses["–û—à–∏–±–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"] = "completed"
                tab_statuses["–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"] = "in_progress"

            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            with st.spinner("–§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏..."):
                manager_recommendations = generate_recommendations(formatted_dialogue)
                tab_statuses["–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"] = "completed"
                tab_statuses["–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞"] = "in_progress"

            # –í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞
            with st.spinner("–ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞..."):
                client_questions = extract_client_questions(formatted_dialogue)
                tab_statuses["–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞"] = "completed"

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Google –¢–∞–±–ª–∏—Ü—É
            with st.spinner("–°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Google –¢–∞–±–ª–∏—Ü—É..."):
                success = save_to_google_sheets(
                    file_name=file_name,
                    transcription=transcription,
                    call_evaluation=qc_analysis,
                    average_score=average_score,
                    manager_errors=manager_errors,
                    improvement_recommendations=manager_recommendations,
                    client_questions=client_questions
                )

            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ —Å —É—á–µ—Ç–æ–º —Å—Ç–∞—Ç—É—Å–æ–≤
            status_emojis = {
                "completed": "üü¢",
                "in_progress": "üîµ",
                "not_started": "‚ö™"
            }
            tab_labels = [f"{status_emojis[tab_statuses[tab]]} {tab}" for tab in tab_statuses]

            # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
            tabs = st.tabs(tab_labels)

            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∫–∞–∂–¥–æ–π –≤–∫–ª–∞–¥–∫–µ
            with tabs[0]:
                st.subheader("–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è")
                st.write(transcription)

            with tabs[1]:
                st.subheader("–î–∏–∞–ª–æ–≥")
                st.write(formatted_dialogue)

            with tabs[2]:
                st.subheader("–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ—Ü–µ–Ω–∫–∏")
                st.write(qc_analysis)
                st.write(f"**–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:** {average_score:.2f}")

            with tabs[3]:
                st.subheader("–û—à–∏–±–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
                st.write(manager_errors)

            with tabs[4]:
                st.subheader("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
                st.write(manager_recommendations)

            with tabs[5]:
                st.subheader("–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞")
                st.write(client_questions)
                # –†–∞–∑–º–µ—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
                if success:
                    st.success("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É.")
                else:
                    st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Google –¢–∞–±–ª–∏—Ü—É.")
